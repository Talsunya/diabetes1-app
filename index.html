<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Контроль диабета</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Дополнительные стили для лучшего отображения */
        input[type="text"], input[type="time"], input[type="date"], textarea, select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, createElement: e } = React;

        const DiabetesApp = () => {
            const [currentView, setCurrentView] = useState('home');
            const [isSetupComplete, setIsSetupComplete] = useState(false);
            const [editingGlucose, setEditingGlucose] = useState(null);
            const [editingWeight, setEditingWeight] = useState(null);
            
            const [userProfile, setUserProfile] = useState({
                height: '',
                weight: '',
                glucoseUnit: 'mmol'
            });
            
            const [glucoseRecords, setGlucoseRecords] = useState([]);
            const [weightRecords, setWeightRecords] = useState([]);
            
            const [glucoseForm, setGlucoseForm] = useState({
                value: '',
                time: '',
                type: 'fasting',
                notes: ''
            });
            
            const [weightForm, setWeightForm] = useState({
                morning: '',
                evening: '',
                date: ''
            });

            useEffect(() => {
                const savedProfile = localStorage.getItem('diabetesProfile');
                const savedGlucose = localStorage.getItem('glucoseRecords');
                const savedWeight = localStorage.getItem('weightRecords');
                
                if (savedProfile) {
                    setUserProfile(JSON.parse(savedProfile));
                    setIsSetupComplete(true);
                }
                
                if (savedGlucose) {
                    setGlucoseRecords(JSON.parse(savedGlucose));
                }
                
                if (savedWeight) {
                    setWeightRecords(JSON.parse(savedWeight));
                }
            }, []);

            const getCurrentTime = () => {
                const now = new Date();
                return now.toTimeString().slice(0, 5);
            };

            const getCurrentDate = () => {
                return new Date().toISOString().split('T')[0];
            };

            const calculateBMI = (weight, height) => {
                const heightM = parseFloat(height) / 100;
                return (parseFloat(weight) / (heightM * heightM)).toFixed(1);
            };

            const calculateWaterIntake = (weight) => {
                return (parseFloat(weight) * 0.04).toFixed(1);
            };

            const printGlucoseTable = () => {
                const printWindow = window.open('', '_blank');
                const glucoseData = glucoseRecords.slice(-30).reverse();
                
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Контроль сахара в крови</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                                h1 { color: #333; }
                                .print-date { color: #666; font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <h1>Контроль уровня сахара в крови</h1>
                            <p class="print-date">Дата печати: ${new Date().toLocaleDateString('ru-RU')}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Время</th>
                                        <th>Значение</th>
                                        <th>Тип измерения</th>
                                        <th>Заметки</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${glucoseData.map(record => `
                                        <tr>
                                            <td>${record.date}</td>
                                            <td>${record.time}</td>
                                            <td>${record.value} ${record.unit === 'mmol' ? 'ммоль/л' : 'мг/дл'}</td>
                                            <td>${record.type === 'fasting' ? 'Натощак' : 
                                                record.type === 'after-meal' ? 'После еды' : 'Перед едой'}</td>
                                            <td>${record.notes || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </body>
                    </html>
                `);
                
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };

            const SetupScreen = () => {
                const [setup, setSetup] = useState({
                    height: '',
                    weight: '',
                    glucoseUnit: 'mmol'
                });

                const handleSetupSubmit = () => {
                    if (setup.height && setup.weight) {
                        setUserProfile(setup);
                        setIsSetupComplete(true);
                        localStorage.setItem('diabetesProfile', JSON.stringify(setup));
                    }
                };

                return e('div', { className: "min-h-screen bg-blue-50 p-4 flex items-center justify-center" },
                    e('div', { className: "bg-white rounded-lg shadow-lg p-6 w-full max-w-md" },
                        e('h2', { className: "text-2xl font-bold text-center mb-6 text-blue-900" }, 
                            "Добро пожаловать!"
                        ),
                        e('p', { className: "text-gray-600 mb-6 text-center" }, 
                            "Пожалуйста, введите ваши основные параметры"
                        ),
                        e('div', { className: "space-y-4" },
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "Рост (см)"
                                ),
                                e('input', {
                                    type: "text",
                                    value: setup.height,
                                    onChange: (event) => setSetup({...setup, height: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",
                                    placeholder: "170"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "Текущий вес (кг)"
                                ),
                                e('input', {
                                    type: "text",
                                    value: setup.weight,
                                    onChange: (event) => setSetup({...setup, weight: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",
                                    placeholder: "75.5"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "Единицы измерения глюкозы"
                                ),
                                e('select', {
                                    value: setup.glucoseUnit,
                                    onChange: (event) => setSetup({...setup, glucoseUnit: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                },
                                    e('option', { value: 'mmol' }, 'ммоль/л'),
                                    e('option', { value: 'mg' }, 'мг/дл')
                                )
                            ),
                            e('button', {
                                type: "button",
                                onClick: handleSetupSubmit,
                                className: "w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"
                            }, "Сохранить и продолжить")
                        )
                    )
                );
            };

            const HomeScreen = () => {
                const currentWeight = weightRecords.length > 0 ? 
                    (weightRecords[weightRecords.length - 1].morning ? weightRecords[weightRecords.length - 1].morning : 
                     weightRecords[weightRecords.length - 1].evening ? weightRecords[weightRecords.length - 1].evening : 
                     parseFloat(userProfile.weight)) 
                    : parseFloat(userProfile.weight);
                
                const bmi = userProfile.height && userProfile.weight ? calculateBMI(currentWeight, userProfile.height) : '0.0';
                const waterIntake = userProfile.weight ? calculateWaterIntake(currentWeight) : '0.0';

                return e('div', { className: "p-4 space-y-6" },
                    e('div', { className: "bg-white rounded-lg shadow p-6" },
                        e('h2', { className: "text-xl font-bold text-gray-800 mb-4" }, "Ваши показатели"),
                        e('div', { className: "grid grid-cols-2 gap-4" },
                            e('div', { className: "text-center p-3 bg-blue-50 rounded-lg" },
                                e('div', { className: "text-2xl font-bold text-blue-600" }, bmi),
                                e('div', { className: "text-sm text-gray-600" }, "ИМТ")
                            ),
                            e('div', { className: "text-center p-3 bg-green-50 rounded-lg" },
                                e('div', { className: "text-2xl font-bold text-green-600" }, waterIntake + 'л'),
                                e('div', { className: "text-sm text-gray-600" }, "Норма воды")
                            )
                        )
                    ),
                    e('div', { className: "space-y-3" },
                        e('button', {
                            onClick: () => {
                                setGlucoseForm({
                                    value: '',
                                    time: getCurrentTime(),
                                    type: 'fasting',
                                    notes: ''
                                });
                                setEditingGlucose(null);
                                setCurrentView('add-glucose');
                            },
                            className: "w-full bg-red-500 text-white p-4 rounded-lg font-medium hover:bg-red-600"
                        }, "+ Добавить уровень сахара"),
                        e('button', {
                            onClick: () => {
                                setWeightForm({
                                    morning: '',
                                    evening: '',
                                    date: getCurrentDate()
                                });
                                setEditingWeight(null);
                                setCurrentView('add-weight');
                            },
                            className: "w-full bg-blue-500 text-white p-4 rounded-lg font-medium hover:bg-blue-600"
                        }, "+ Добавить вес"),
                        e('button', {
                            onClick: () => setCurrentView('stats'),
                            className: "w-full bg-green-500 text-white p-3 rounded-lg font-medium hover:bg-green-600"
                        }, "📊 Статистика"),
                        e('button', {
                            onClick: () => setCurrentView('settings'),
                            className: "w-full bg-gray-500 text-white p-3 rounded-lg font-medium hover:bg-gray-600"
                        }, "⚙️ Настройки")
                    )
                );
            };

            const AddGlucoseScreen = () => {
                const handleSubmit = () => {
                    if (glucoseForm.value && glucoseForm.time) {
                        if (editingGlucose) {
                            const updatedRecords = glucoseRecords.map(record =>
                                record.id === editingGlucose.id
                                    ? {
                                        ...record,
                                        value: parseFloat(glucoseForm.value),
                                        time: glucoseForm.time,
                                        type: glucoseForm.type,
                                        notes: glucoseForm.notes
                                    }
                                    : record
                            );
                            setGlucoseRecords(updatedRecords);
                            localStorage.setItem('glucoseRecords', JSON.stringify(updatedRecords));
                            setEditingGlucose(null);
                        } else {
                            const newRecord = {
                                id: Date.now(),
                                value: parseFloat(glucoseForm.value),
                                time: glucoseForm.time,
                                type: glucoseForm.type,
                                notes: glucoseForm.notes,
                                date: getCurrentDate(),
                                unit: userProfile.glucoseUnit
                            };
                            
                            const updatedRecords = [...glucoseRecords, newRecord];
                            setGlucoseRecords(updatedRecords);
                            localStorage.setItem('glucoseRecords', JSON.stringify(updatedRecords));
                        }
                        
                        setCurrentView('home');
                        setGlucoseForm({
                            value: '',
                            time: '',
                            type: 'fasting',
                            notes: ''
                        });
                    }
                };

                return e('div', { className: "p-4" },
                    e('div', { className: "bg-white rounded-lg shadow p-6" },
                        e('h2', { className: "text-xl font-bold text-gray-800 mb-6" },
                            editingGlucose ? 'Редактировать уровень сахара' : 'Добавить уровень сахара'
                        ),
                        e('div', { className: "space-y-4" },
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    `Значение (${userProfile.glucoseUnit === 'mmol' ? 'ммоль/л' : 'мг/дл'})`
                                ),
                                e('input', {
                                    type: "text",
                                    value: glucoseForm.value,
                                    onChange: (event) => setGlucoseForm({...glucoseForm, value: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",
                                    placeholder: userProfile.glucoseUnit === 'mmol' ? "5.5" : "100"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "Время измерения"
                                ),
                                e('input', {
                                    type: "time",
                                    value: glucoseForm.time,
                                    onChange: (event) => setGlucoseForm({...glucoseForm, time: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "Тип измерения"
                                ),
                                e('select', {
                                    value: glucoseForm.type,
                                    onChange: (event) => setGlucoseForm({...glucoseForm, type: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                },
                                    e('option', { value: 'fasting' }, 'Натощак'),
                                    e('option', { value: 'after-meal' }, 'После еды'),
                                    e('option', { value: 'before-meal' }, 'Перед едой')
                                )
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "Заметки (необязательно)"
                                ),
                                e('textarea', {
                                    value: glucoseForm.notes,
                                    onChange: (event) => setGlucoseForm({...glucoseForm, notes: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",
                                    rows: 3,
                                    placeholder: "Дополнительная информация"
                                })
                            ),
                            e('div', { className: "flex space-x-3" },
                                e('button', {
                                    onClick: () => {
                                        setCurrentView('home');
                                        setEditingGlucose(null);
                                        setGlucoseForm({
                                            value: '',
                                            time: '',
                                            type: 'fasting',
                                            notes: ''
                                        });
                                    },
                                    className: "flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"
                                }, "Отмена"),
                                e('button', {
                                    onClick: handleSubmit,
                                    className: "flex-1 bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600"
                                }, editingGlucose ? 'Сохранить изменения' : 'Сохранить')
                            )
                        )
                    )
                );
            };

            const AddWeightScreen = () => {
                const handleSubmit = () => {
                    if ((weightForm.morning || weightForm.evening) && weightForm.date) {
                        const newRecord = {
                            id: Date.now(),
                            date: weightForm.date,
                            morning: weightForm.morning ? parseFloat(weightForm.morning) : null,
                            evening: weightForm.evening ? parseFloat(weightForm.evening) : null
                        };
                        
                        const updatedRecords = [...weightRecords, newRecord];
                        setWeightRecords(updatedRecords);
                        localStorage.setItem('weightRecords', JSON.stringify(updatedRecords));
                        
                        setCurrentView('home');
                        setWeightForm({
                            morning: '',
                            evening: '',
                            date: getCurrentDate()
                        });
                    }
                };

                return e('div', { className: "p-4" },
                    e('div', { className: "bg-white rounded-lg shadow p-6" },
                        e('h2', { className: "text-xl font-bold text-gray-800 mb-6" }, "Добавить вес"),
                        e('div', { className: "space-y-4" },
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Дата"),
                                e('input', {
                                    type: "date",
                                    value: weightForm.date,
                                    onChange: (event) => setWeightForm({...weightForm, date: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Утренний вес (кг)"),
                                e('input', {
                                    type: "text",
                                    value: weightForm.morning,
                                    onChange: (event) => setWeightForm({...weightForm, morning: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",
                                    placeholder: "75.5"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Вечерний вес (кг)"),
                                e('input', {
                                    type: "text",
                                    value: weightForm.evening,
                                    onChange: (event) => setWeightForm({...weightForm, evening: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",
                                    placeholder: "76.0"
                                })
                            ),
                            e('div', { className: "flex space-x-3" },
                                e('button', {
                                    onClick: () => setCurrentView('home'),
                                    className: "flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"
                                }, "Отмена"),
                                e('button', {
                                    onClick: handleSubmit,
                                    className: "flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600"
                                }, "Сохранить")
                            )
                        )
                    )
                );
            };

            const StatsScreen = () => {
                return e('div', { className: "p-4 space-y-6" },
                    e('div', { className: "bg-white rounded-lg shadow p-6" },
                        e('div', { className: "flex justify-between items-center mb-4" },
                            e('h2', { className: "text-xl font-bold text-gray-800" }, "Статистика"),
                            e('button', {
                                onClick: () => setCurrentView('home'),
                                className: "text-blue-500 hover:text-blue-700 font-medium"
                            }, "← Назад")
                        ),
                        e('div', { className: "mb-6" },
                            e('div', { className: "flex justify-between items-center mb-3" },
                                e('h3', { className: "text-lg font-semibold text-gray-700" }, "Уровень сахара"),
                                e('button', {
                                    onClick: printGlucoseTable,
                                    className: "bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600"
                                }, "🖨️ Печать")
                            ),
                            e('div', { className: "space-y-2 max-h-40 overflow-y-auto" },
                                ...glucoseRecords.slice(-10).reverse().map((record) =>
                                    e('div', { key: record.id, className: "p-3 bg-gray-50 rounded-lg" },
                                        e('div', { className: "flex justify-between items-center" },
                                            e('div', {},
                                                e('span', { className: "font-medium" },
                                                    `${record.value} ${record.unit === 'mmol' ? 'ммоль/л' : 'мг/дл'}`
                                                ),
                                                e('div', { className: "text-sm text-gray-600" },
                                                    `${record.date} ${record.time}`
                                                ),
                                                e('div', { className: "text-sm text-gray-600" },
                                                    record.type === 'fasting' ? 'Натощак' : 
                                                    record.type === 'after-meal' ? 'После еды' : 'Перед едой'
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                );
            };

            const SettingsScreen = () => {
                const [editProfile, setEditProfile] = useState({...userProfile});

                const handleSaveProfile = () => {
                    setUserProfile(editProfile);
                    localStorage.setItem('diabetesProfile', JSON.stringify(editProfile));
                    alert('Настройки сохранены!');
                };

                return e('div', { className: "p-4" },
                    e('div', { className: "bg-white rounded-lg shadow p-6" },
                        e('div', { className: "flex justify-between items-center mb-6" },
                            e('h2', { className: "text-xl font-bold text-gray-800" }, "Настройки"),
                            e('button', {
                                onClick: () => setCurrentView('home'),
                                className: "text-blue-500 hover:text-blue-700 font-medium"
                            }, "← Назад")
                        ),
                        e('div', { className: "space-y-4" },
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Рост (см)"),
                                e('input', {
                                    type: "text",
                                    value: editProfile.height,
                                    onChange: (event) => setEditProfile({...editProfile, height: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                })
                            ),
                            e('div', {},
                                e('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Текущий вес (кг)"),
                                e('input', {
                                    type: "text",
                                    value: editProfile.weight,
                                    onChange: (event) => setEditProfile({...editProfile, weight: event.target.value}),
                                    className: "w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                })
                            ),
                            e('button', {
                                onClick: handleSaveProfile,
                                className: "w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600"
                            }, "Сохранить изменения")
                        )
                    )
                );
            };

            if (!isSetupComplete) {
                return e(SetupScreen);
            }

            if (currentView === 'add-glucose') {
                return e(AddGlucoseScreen);
            }

            if (currentView === 'add-weight') {
                return e(AddWeightScreen);
            }

            if (currentView === 'stats') {
                return e(StatsScreen);
            }

            if (currentView === 'settings') {
                return e(SettingsScreen);
            }

            return e(HomeScreen);
        };

        ReactDOM.render(React.createElement(DiabetesApp), document.getElementById('root'));
    </script>
</body>
</html>
